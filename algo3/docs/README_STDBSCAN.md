# ST-DBSCAN実装: 時空間降水クラスタリング

## 概要

ST-DBSCAN (Spatio-Temporal DBSCAN) を使用して、時空間気象データから降水地点をクラスタリングし、雨雲の動きを可視化します。

## 実装内容

### ファイル構成

- `st_dbscan.py` - ST-DBSCANアルゴリズムの実装
- `test_clustering.py` - テスト用スクリプト（架空データで動作確認）
- `requirements.txt` - 必要なパッケージリスト
- `README_STDBSCAN.md` - このファイル

## ST-DBSCANアルゴリズムについて

### 基本概念

ST-DBSCANは、DBSCANアルゴリズムを時空間データに拡張したものです。通常のDBSCANが空間的な近さのみを考慮するのに対し、ST-DBSCANは空間的な近さと時間的な近さの両方を考慮します。

### パラメータ

1. **eps1** (空間距離の閾値)
   - 2点が空間的に「近い」とみなされる最大距離（km）
   - 値が小さい→厳密なクラスタ、値が大きい→緩いクラスタ

2. **eps2** (時間距離の閾値)
   - 2点が時間的に「近い」とみなされる最大時間差
   - 値が小さい→同時刻のみ、値が大きい→時間的に離れた点も同じクラスタに

3. **min_pts** (最小ポイント数)
   - コアポイントとなるために必要な近傍ポイント数
   - 値が大きい→大きなクラスタのみ検出、値が小さい→小さなクラスタも検出

### アルゴリズムの流れ

1. 各ポイントについて、ST近傍（空間的かつ時間的に近いポイント）を探す
2. 十分な数の近傍を持つポイントをコアポイントとする
3. コアポイントから到達可能なポイントをクラスタに含める
4. どのクラスタにも属さないポイントをノイズとする

## 使い方

### 環境構築

```powershell
# 仮想環境の作成（推奨）
python -m venv venv
.\venv\Scripts\Activate.ps1

# パッケージのインストール
pip install -r requirements.txt
```

### テストの実行

架空データを使ってクラスタリングをテストします：

```powershell
python test_clustering.py
```

このスクリプトは以下を実行します：
1. 3つの移動する雨雲を含む架空データを生成
2. ST-DBSCANでクラスタリング
3. 統計情報を表示
4. 2D・3D可視化を生成
5. アニメーションを作成（オプション）

### 実データでの使用例

```python
from st_dbscan import STDBSCAN, create_precipitation_data
import numpy as np

# データの準備（例）
lats = np.array([35.0, 35.1, 35.2, ...])  # 緯度
lons = np.array([139.0, 139.1, 139.2, ...])  # 経度
times = np.array([0, 0, 0, ...])  # 時刻
values = np.array([5.0, 3.2, 8.5, ...])  # 降水量

# 降水地点データに変換（閾値: 1.0 mm/h以上）
points = create_precipitation_data(lats, lons, times, values, threshold=1.0)

# ST-DBSCANの実行
stdbscan = STDBSCAN(
    eps1=0.15,    # 空間距離: 15km
    eps2=2.0,     # 時間距離: 2タイムステップ
    min_pts=10    # 最小ポイント数: 10
)
stdbscan.fit(points)

# 結果の取得
clusters = stdbscan.get_clusters()
stats = stdbscan.get_statistics()

print(f"検出されたクラスタ数: {stats['n_clusters']}")
```

## パラメータチューニングのヒント

### eps1 (空間距離)
- 降水域の典型的なサイズを考慮
- 10-30kmが一般的な開始点
- 小さすぎる→多くのノイズ、大きすぎる→全てが1つのクラスタに

### eps2 (時間距離)
- 雨雲の移動速度とデータの時間間隔を考慮
- 時速30kmで移動する雨雲、10分間隔のデータなら、1-2ステップ程度
- 小さすぎる→時間的に分断、大きすぎる→無関係な雨雲が結合

### min_pts
- 検出したい最小クラスタサイズを考慮
- 5-20が一般的な範囲
- データの密度に依存

## 出力ファイル

- `clustering_result_2d.png` - 2D空間上のクラスタリング結果
  - 左図: 時刻による色分け
  - 右図: クラスタIDによる色分け

- `clustering_result_3d.png` - 3D時空間上のクラスタリング結果
  - X軸: 経度、Y軸: 緯度、Z軸: 時刻

- `rain_animation.gif` - 雨雲の時間変化アニメーション
  - 時刻ごとのクラスタの動きを表示

## 実装の特徴

### 1. Haversine距離の使用
- 地球が球体であることを考慮した正確な距離計算
- 緯度・経度から実際の距離（km）を算出

### 2. 効率的なアルゴリズム
- 幅優先探索によるクラスタ拡張
- クリーンなクラスID管理

### 3. 詳細な統計情報
- クラスタ数、ノイズ比率、クラスタサイズなど
- 結果の評価に有用

### 4. 柔軟なデータ構造
- `STPoint`クラスによる明確なデータ表現
- 降水量などの属性値も保持

## 参考文献

Birant, D., & Kut, A. (2007). ST-DBSCAN: An algorithm for clustering spatial-temporal data. Data & Knowledge Engineering, 60(1), 208-221.

## 今後の拡張可能性

1. **高速化**
   - KD-Treeやball treeによる近傍探索の高速化
   - Numbaによるコンパイル

2. **パラメータ自動調整**
   - グリッドサーチによる最適パラメータ探索
   - シルエット係数などの評価指標の導入

3. **可視化の強化**
   - インタラクティブな可視化（Plotly等）
   - 地図上への重ね合わせ

4. **実データ対応**
   - 気象データAPIとの連携
   - 大規模データへの対応

## トラブルシューティング

### クラスタが検出されない
- eps1, eps2が小さすぎる可能性 → 値を大きくする
- min_ptsが大きすぎる可能性 → 値を小さくする

### 全てが1つのクラスタになる
- eps1, eps2が大きすぎる可能性 → 値を小さくする

### ノイズが多すぎる
- min_ptsが大きすぎる可能性 → 値を小さくする
- データの密度が低い可能性 → eps1, eps2を大きくする
